# 模块设计: 计费中台

生成时间: 2026-01-21 14:37:48
批判迭代: 1

---

# 计费中台模块设计文档

## 1. 概述

### 目的与范围
计费中台模块为"天财分账"业务提供统一的转账计费能力。其核心职责是接收来自三代系统同步的手续费配置，并在处理分账、归集、批量付款、会员结算等资金流转交易时，根据业务规则（如"分账手续费承担方"）进行计费处理。本模块不涉及费率策略的制定，仅负责执行计费计算与扣费。

## 2. 接口设计

### API端点
- TBD

### 发布/消费的事件
- **消费的事件**:
    - 事件来源：三代系统
    - 事件内容：手续费配置同步事件。当三代系统为商户或特定业务场景配置或更新手续费规则（如指定手续费承担方）时，会发布此事件，计费中台需监听并更新本地配置缓存。
- **发布的事件**:
    - TBD

## 3. 数据模型

### 表/集合
- **手续费配置表** (`fee_config`)
    - 用于存储从三代系统同步的计费规则。
- **计费记录表** (`fee_record`)
    - 用于记录每一笔交易产生的计费详情。

### 关键字段
- **`fee_config` 表**:
    - `id`: 主键
    - `merchant_id`: 商户ID（关联总部或门店）
    - `business_scenario`: 业务场景（如：归集、批量付款、会员结算）
    - `fee_payer`: 手续费承担方（付方/收方）
    - `fee_rule`: 费率规则详情（JSON格式，如固定金额、百分比等）
    - `effective_time`: 生效时间
    - `sync_source`: 同步来源（如"三代系统"）
    - `sync_time`: 配置同步时间
- **`fee_record` 表**:
    - `id`: 主键
    - `transaction_id`: 关联的交易流水号（来自业务核心系统或行业钱包系统）
    - `fee_config_id`: 关联的手续费配置ID
    - `calculated_amount`: 计算出的手续费金额
    - `actual_deducted_amount`: 实际扣费金额（可能因余额不足等调整）
    - `payer_identity`: 手续费支付方身份（总部/门店）
    - `payer_account`: 手续费支付方账户
    - `status`: 状态（待扣费、已扣费、扣费失败）
    - `create_time`: 记录创建时间

### 与其他模块的关系
- **三代系统**: 是计费规则配置的源头，通过事件将配置同步至计费中台。
- **行业钱包系统/业务核心系统**: 在处理涉及资金流转的交易时，调用计费中台进行计费计算与扣费。
- **账户系统**: 计费中台在执行实际扣费时，需与账户系统交互，从指定的"手续费承担方"账户中扣减资金。

## 4. 业务逻辑

### 核心工作流/算法
1.  **配置同步**:
    - 监听三代系统发布的"手续费配置同步事件"。
    - 解析事件数据，更新或插入本地`fee_config`表。需处理配置的版本与生效时间。
2.  **计费触发与计算**:
    - 接收来自行业钱包系统或业务核心系统的计费请求。请求应包含：交易流水号、业务场景、付方信息、收方信息、交易金额等。
    - 根据`merchant_id`和`business_scenario`查询当前生效的`fee_config`。
    - 根据配置中的`fee_payer`（付方/收方）确定手续费承担方。
    - 根据`fee_rule`和交易金额，计算手续费`calculated_amount`。
3.  **扣费执行**:
    - 根据确定的承担方，调用账户系统接口，从其对应的账户（如天财收款账户）中扣减`calculated_amount`。
    - 根据扣费结果，更新`fee_record`表中的状态和实际扣费金额。
    - 将扣费结果（成功/失败及原因）返回给调用方。

### 业务规则与验证
- **规则匹配**: 必须精确匹配商户、业务场景和生效时间，以找到正确的计费配置。
- **承担方校验**: 验证`fee_payer`指定的承担方账户是否存在且状态正常。
- **余额校验**: 在执行扣费前，应确认承担方账户余额充足（或由账户系统保障）。
- **幂等性**: 针对同一笔`transaction_id`的计费请求，应保证计费操作只执行一次。

### 关键边界情况
- **配置缺失**: 若未找到对应计费配置，应返回明确错误，由上游业务系统决定是否阻断交易或按默认规则处理。
- **扣费失败**: 若账户系统扣费失败（如余额不足、账户冻结），需准确记录失败原因并通知上游。
- **配置冲突**: 当同一商户同一场景存在多条时间重叠的生效配置时，需要有明确的冲突解决策略（如取最新同步的配置）。

## 5. 序列图

```mermaid
sequenceDiagram
    participant A as 三代系统
    participant B as 计费中台
    participant C as 行业钱包系统
    participant D as 账户系统

    Note over A,B: 配置同步流程
    A->>B: 发布事件：手续费配置更新
    B->>B: 解析并持久化配置(fee_config)

    Note over C,B,D: 交易计费流程
    C->>B: 请求计费(交易号,场景,金额,付方,收方)
    B->>B: 查询生效计费配置
    B->>B: 计算手续费及承担方
    B->>D: 请求扣费(承担方账户,手续费金额)
    D->>D: 执行账户扣款
    D->>B: 返回扣费结果
    B->>B: 记录计费结果(fee_record)
    B->>C: 返回计费结果(成功/失败)
```

## 6. 错误处理

### 预期错误案例
1.  **配置查询失败**: 未找到匹配的计费配置。
2.  **计算错误**: 费率规则非法或计算过程出现异常。
3.  **账户交互失败**: 调用账户系统超时、网络异常或返回业务失败（余额不足、账户不存在）。
4.  **数据一致性错误**: 重复的`transaction_id`请求导致重复计费风险。

### 处理策略
- **优雅降级**: 对于配置缺失，可向上游返回特定错误码，而非系统异常。
- **重试机制**: 对账户系统等外部依赖的调用失败，应有策略性重试（特别是对于网络超时）。
- **事务与补偿**: 确保计费记录与账户扣费状态的一致性。若扣费成功但记录失败，需有对账与补偿机制（如定时核对账户流水与`fee_record`）。
- **幂等控制**: 通过`transaction_id`唯一键约束或业务逻辑校验，防止重复计费。

## 7. 依赖关系

### 上游模块
- **三代系统**: 核心依赖。计费中台所有业务计费规则均来源于此。通过异步事件接收配置变更。
- **行业钱包系统 / 业务核心系统**: 服务调用方。在处理"天财分账"相关交易时，同步调用计费中台完成计费环节。

### 下游模块
- **账户系统**: 核心依赖。计费中台需调用账户系统完成实际资金的扣划操作。

### 交互方式
- 与**三代系统**采用异步事件驱动（消息队列）进行配置同步，保证最终一致性。
- 与**行业钱包系统/业务核心系统**采用同步RPC调用，确保在交易处理流程中实时完成计费。
- 与**账户系统**采用同步RPC调用，实时完成资金扣减。