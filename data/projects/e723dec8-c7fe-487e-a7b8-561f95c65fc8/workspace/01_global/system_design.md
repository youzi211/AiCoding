## 2.1 系统结构
天财分账系统采用分层架构，旨在为天财商龙商户提供门店分账、会员结算与批量付款服务。系统以行业钱包系统为核心业务处理引擎，整合账户、认证、签约、清结算等能力，通过三代系统作为统一业务入口，为钱包App/商服平台提供前端服务支持。

```mermaid
graph TB
    subgraph "前端接入层"
        A[钱包App/商服平台]
    end

    subgraph "业务服务层"
        B1[三代系统]
        B2[行业钱包系统]
        B3[电子签约平台]
        B4[业务核心系统]
    end

    subgraph "基础能力层"
        C1[账户系统]
        C2[认证系统]
        C3[清结算系统]
        C4[计费中台]
    end

    subgraph "数据与报表层"
        D[对账单系统]
    end

    A -- 业务发起/查询 --> B1
    B1 -- 账户开立/状态查询 --> C1
    B1 -- 签约/验证流程 --> B3
    B1 -- 分账指令 --> B2
    B2 -- 账户管理/关系校验 --> C1
    B2 -- 交易处理 --> B4
    B2 -- 结算/冻结 --> C3
    B2 -- 计费协同 --> C4
    B3 -- 身份核验 --> C2
    B4 -- 资金划转/状态同步 --> C3
    C3 -- 计费信息同步 --> C4
    D -- 数据采集 --> B2
    D -- 数据采集 --> C1
    D -- 数据采集 --> B4
```

## 2.2 功能结构
系统功能围绕天财分账的核心业务流程展开，主要划分为账户与商户管理、关系绑定与认证、资金分账处理、清结算与计费、以及数据对账五大功能域。

```mermaid
graph TD
    Root[天财分账系统] --> F1[账户与商户管理]
    Root --> F2[关系绑定与认证]
    Root --> F3[资金分账处理]
    Root --> F4[清结算与计费]
    Root --> F5[数据对账]

    F1 --> F1_1[天财账户开立与标记]
    F1 --> F1_2[商户信息管理]
    F1 --> F1_3[结算模式配置]

    F2 --> F2_1[关系绑定签约]
    F2 --> F2_2[打款验证]
    F2 --> F2_3[人脸验证]
    F2 --> F2_4[开通付款认证]

    F3 --> F3_1[资金归集]
    F3 --> F3_2[批量付款]
    F3 --> F3_3[会员结算]
    F3 --> F3_4[交易处理与路由]

    F4 --> F4_1[结算账户配置]
    F4 --> F4_2[账户资金冻结]
    F4 --> F4_3[手续费计算与扣费]
    F4 --> F4_4[退货账户查询]

    F5 --> F5_1[交易明细采集]
    F5 --> F5_2[多类型对账单生成]
    F5 --> F5_3[内外数据对账]
```

## 2.3 网络拓扑图
TBD

## 2.4 数据流转
数据流转以核心业务流程驱动，涉及商户信息、账户信息、关系绑定数据、交易指令及资金流水在多系统间的传递与状态同步。

```mermaid
flowchart LR
    Start([商户操作]) --> Step1[三代系统]
    Step1 -- 1. 请求开户 --> Step2[账户系统]
    Step2 -- 2. 返回账户号 --> Step1
    Step1 -- 3. 发起关系绑定 --> Step3[电子签约平台]
    Step3 -- 4. 调用验证 --> Step4[认证系统]
    Step4 -- 5. 返回验证结果 --> Step3
    Step3 -- 6. 返回签约结果 --> Step1
    Step1 -- 7. 发起分账指令 --> Step5[行业钱包系统]
    Step5 -- 8. 校验关系/账户 --> Step1
    Step5 -- 9. 请求处理交易 --> Step6[业务核心系统]
    Step6 -- 10. 请求计费 --> Step7[计费中台]
    Step7 -- 11. 请求扣费 --> Step2
    Step6 -- 12. 请求资金划转/冻结 --> Step8[清结算系统]
    Step8 -- 13. 处理完成 --> Step6
    Step6 -- 14. 返回交易结果 --> Step5
    Step5 -- 15. 同步交易结果 --> Step1
    Step5 -- 16. 同步交易数据 --> Step9[对账单系统]
    Step6 -- 17. 同步交易数据 --> Step9
    Step2 -- 18. 同步账户数据 --> Step9
    Step8 -- 19. 同步结算数据 --> Step9
```

## 2.5 系统模块交互关系
模块间通过定义清晰的接口进行协作。三代系统作为主要业务入口，依赖行业钱包系统处理核心分账逻辑；行业钱包系统作为枢纽，协调账户、清结算、计费等底层能力；对账单系统作为数据汇总端，依赖多个业务模块提供数据。

```mermaid
graph TD
    A[三代系统]
    B[行业钱包系统]
    C[账户系统]
    D[电子签约平台]
    E[认证系统]
    F[清结算系统]
    G[计费中台]
    H[业务核心系统]
    I[对账单系统]

    A -- 1. 开户/查询账户 --> C
    A -- 2. 发起签约/验证 --> D
    A -- 3. 发起分账指令/查询关系 --> B
    B -- 4. 校验账户/关系 --> A
    B -- 5. 管理账户/查询状态 --> C
    B -- 6. 处理结算/冻结 --> F
    B -- 7. 提交交易处理 --> H
    B -- 8. 同步交易数据 --> I
    D -- 9. 调用身份核验 --> E
    H -- 10. 请求资金划转 --> F
    H -- 11. 请求计费 --> G
    G -- 12. 执行扣费 --> C
    I -- 13. 采集数据 --> C
    I -- 14. 采集数据 --> B
    I -- 15. 采集数据 --> H
    I -- 16. 采集数据 --> F
```