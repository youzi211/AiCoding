# 4. 接口设计

## 4.1 对外接口
指系统向外部系统（如收单系统、第三方服务、商户前端应用等）暴露的API接口。

### 4.1.1 账户管理
| 接口路径与方法 | 所属模块 | 功能说明 | 请求/响应格式 |
| :--- | :--- | :--- | :--- |
| `POST /api/v1/accounts/payment` | 账户系统 | 创建天财收款账户。为分账业务的资金接收方（如平台、总部）创建专用账户。 | **请求:** 商户ID、账户类型、业务标签等。<br>**响应:** 账户号、状态。 |
| `POST /api/v1/accounts/receiver` | 账户系统 | 创建天财接收方账户。为分账业务的资金接收方（如门店、个人）创建专用账户。 | **请求:** 接收方身份信息、关联业务ID、银行卡信息等。<br>**响应:** 账户号、状态。 |
| `GET /api/v1/accounts/{accountNo}` | 账户系统 | 查询指定账户的详细信息，包括状态、余额、关联业务等。 | **响应:** 账户详情对象。 |
| `GET /api/v1/accounts` | 账户系统 | 根据商户ID、账户类型、状态等条件查询账户列表。 | **请求:** 查询条件参数。<br>**响应:** 账户列表。 |
| `PATCH /api/v1/accounts/{accountNo}/status` | 账户系统 | 更新账户状态，如启用、禁用、注销。 | **请求:** 目标状态。<br>**响应:** 操作结果。 |

### 4.1.2 身份认证与关系绑定
| 接口路径与方法 | 所属模块 | 功能说明 | 请求/响应格式 |
| :--- | :--- | :--- | :--- |
| `POST /api/v1/auth/relationships` | 认证系统 | 为收付款方创建关系绑定，并触发后续的账户所有权认证流程（如打款验证、人脸核验、电子签约）。 | **请求:** 付款方账户、接收方账户、关系类型、认证方式等。<br>**响应:** 关系绑定ID、下一步操作指引。 |
| `GET /api/v1/auth/relationships/{relationshipId}` | 认证系统 | 查询指定关系绑定的详细状态和认证进度。 | **响应:** 关系详情、当前状态、各认证步骤结果。 |
| `POST /api/v1/auth/relationships/{relationshipId}/unbind` | 认证系统 | 解除已生效的关系绑定。 | **请求:** 解除原因。<br>**响应:** 操作结果。 |
| `POST /api/v1/auth/verifications/transfer-confirm` | 认证系统 | 接收方回填打款验证金额，以确认其对指定银行账户的所有权。 | **请求:** 关系绑定ID、验证金额。<br>**响应:** 验证结果。 |
| `POST /api/v1/auth/callback/face-verification` | 认证系统 | **回调接口**。接收电子签约平台推送的人脸核验最终结果。 | **请求:** 核验任务ID、核验结果、签署方信息等。 |

### 4.1.3 电子签约与核验
| 接口路径与方法 | 所属模块 | 功能说明 | 请求/响应格式 |
| :--- | :--- | :--- | :--- |
| `POST /api/v1/verification/face/initiate` | 电子签约平台 | 发起人脸核验任务，返回核验链接或SDK所需参数。 | **请求:** 被核验人信息、业务关联ID。<br>**响应:** 核验任务ID、核验链接/参数。 |
| `GET /api/v1/verification/face/{verificationId}` | 电子签约平台 | 查询人脸核验任务的状态与详细结果。 | **响应:** 核验状态、结果、时间等。 |
| `POST /api/v1/contract/initiate` | 电子签约平台 | 创建并启动一份电子协议的签署流程，添加签署方并发送签署任务。 | **请求:** 模板ID、签署方列表、业务变量。<br>**响应:** 协议ID、签署任务链接。 |
| `GET /api/v1/contract/{contractId}` | 电子签约平台 | 查询电子协议的详细信息及各签署方的当前状态。 | **响应:** 协议详情、签署方状态列表。 |
| `POST /api/v1/contract/{contractId}/revoke` | 电子签约平台 | 在协议所有方签署完成前，撤销该协议流程。 | **请求:** 撤销原因。<br>**响应:** 操作结果。 |

### 4.1.4 分账指令与交易
| 接口路径与方法 | 所属模块 | 功能说明 | 请求/响应格式 |
| :--- | :--- | :--- | :--- |
| `POST /api/v1/transfers` | 账务核心系统 | 创建并执行一笔分账指令。是分账资金划转的核心入口。 | **请求:** 付款账户、收款账户、金额、业务订单号、手续费承担方等。<br>**响应:** 分账交易ID、状态。 |
| `GET /api/v1/transfers/{transferId}` | 账务核心系统 | 查询一笔分账交易的详细信息及执行状态。 | **响应:** 交易详情，包括参与方、金额、状态、时间戳等。 |
| `POST /api/v1/transfers/{transferId}/reverse` | 账务核心系统 | 对指定分账交易进行冲正。 | **请求:** 冲正原因。<br>**响应:** 冲正交易ID。 |
| `POST /api/v1/instructions/collection` | 三代系统 | 发起一笔资金归集指令，将门店账户资金归集至总部账户。 | **请求:** 归集关系ID、金额、业务参考号。<br>**响应:** 指令ID、状态。 |

### 4.1.5 清结算
| 接口路径与方法 | 所属模块 | 功能说明 | 请求/响应格式 |
| :--- | :--- | :--- | :--- |
| `PUT /api/v1/merchants/{merchantId}/settlement-config` | 清结算系统 | 配置或更新商户的结算模式与规则（如结算周期、结算账户）。 | **请求:** 结算配置信息。<br>**响应:** 操作结果。 |
| `POST /api/v1/settlements/execute` | 清结算系统 | 执行结算，将商户的待结算账户资金结算到其天财收款账户。 | **请求:** 商户ID、结算日期、结算批次号。<br>**响应:** 结算执行ID。 |
| `POST /api/v1/refunds/process` | 清结算系统 | 处理退货退款请求，进行资金逆向划转。 | **请求:** 原交易号、退款金额、退款原因等。<br>**响应:** 退款流水号。 |
| `POST /api/v1/transfers/tiancai-split` | 清结算系统 | **供行业钱包系统调用**。处理天财分账资金在内部账户间的划转请求。 | **请求:** 付款内部账户、收款内部账户、金额、业务流水号。<br>**响应:** 清算流水号、状态。 |

### 4.1.6 手续费计算
| 接口路径与方法 | 所属模块 | 功能说明 | 请求/响应格式 |
| :--- | :--- | :--- | :--- |
| `POST /api/v1/fee/calculate` | 计费中台 | 根据业务参数（如交易金额、账户类型、业务场景）计算实际应收的手续费。 | **请求:** 业务场景、交易金额、参与方信息等。<br>**响应:** 手续费金额、计费规则ID、明细。 |
| `POST /api/v1/fee/estimate` | 计费中台 | 手续费试算接口，用于业务发起前的费用预估，不产生实际计费记录。 | **请求:** 同`/calculate`接口。<br>**响应:** 预估手续费金额。 |

### 4.1.7 对账单服务
| 接口路径与方法 | 所属模块 | 功能说明 | 请求/响应格式 |
| :--- | :--- | :--- | :--- |
| `POST /api/v1/statements/generate` | 对账单系统 | 触发指定类型和周期的对账单生成任务。 | **请求:** 账单类型（如日结单、月结单）、商户ID、账单日期。<br>**响应:** 账单生成任务ID。 |
| `GET /api/v1/statements` | 对账单系统 | 根据条件查询已生成的对账单列表。 | **请求:** 商户ID、账单类型、日期范围、状态。<br>**响应:** 对账单概要列表。 |
| `GET /api/v1/statements/{statementNo}/download` | 对账单系统 | 下载指定对账单的文件（如PDF、Excel）。 | **响应:** 文件流。 |
| `GET /api/v1/statements/preview` | 对账单系统 | 预览对账单数据，通常以JSON格式返回，不生成文件。 | **请求:** 同`/generate`接口。<br>**响应:** 账单明细数据。 |

### 4.1.8 前端应用接口 (钱包APP/商服平台)
| 接口路径与方法 | 所属模块 | 功能说明 | 请求/响应格式 |
| :--- | :--- | :--- | :--- |
| `POST /api/app/v1/auth/login` | 钱包APP/商服平台 | 用户登录认证。 | **请求:** 用户名、密码/验证码。<br>**响应:** 令牌(Token)、用户信息。 |
| `GET /api/app/v1/accounts/overview` | 钱包APP/商服平台 | 获取当前用户所属商户的账户概览信息，如总余额、可用余额、今日交易概览等。 | **响应:** 账户概览对象。 |
| `GET /api/app/v1/relationships/collection/guide` | 钱包APP/商服平台 | 获取创建资金归集关系的引导信息，如所需材料、认证步骤说明。 | **响应:** 引导步骤列表。 |
| `POST /api/app/v1/relationships/collection/initiate` | 钱包APP/商服平台 | 发起归集关系签约请求，引导用户完成电子签约流程。 | **请求:** 总部账户、门店账户信息。<br>**响应:** 电子签约流程ID。 |
| `POST /api/app/v1/instructions/collection/manual` | 钱包APP/商服平台 | 手动发起一笔单店资金归集指令。 | **请求:** 门店账户、归集金额。<br>**响应:** 指令提交结果。 |

## 4.2 模块间接口
指“天财分账”系统内部各微服务/模块之间的关键调用接口。

### 4.2.1 账户系统
| 接口路径与方法 | 调用方模块 | 功能说明 |
| :--- | :--- | :--- |
| `GET /api/v1/accounts/{accountNo}/balance` (内部) | 账务核心系统、行业钱包系统 | 查询账户的实时可用余额与冻结余额。 |
| `POST /api/v1/accounts/{accountNo}/freeze` (内部) | 账务核心系统 | 冻结账户中指定金额的资金。 |
| `GET /internal/v1/accounts/by-merchant` (内部) | 三代系统、清结算系统 | 根据商户ID获取其关联的所有天财账户。 |

### 4.2.2 认证系统
| 接口路径与方法 | 调用方模块 | 功能说明 |
| :--- | :--- | :--- |
| `GET /internal/v1/auth/relationships/validate` (内部) | 行业钱包系统、三代系统 | 校验两个账户间是否存在已认证生效的特定业务关系。 |
| `POST /internal/v1/auth/trigger-verification` (内部) | 三代系统 | 在创建业务关系后，触发指定的认证流程（如打款验证）。 |

### 4.2.3 三代系统
| 接口路径与方法 | 调用方模块 | 功能说明 |
| :--- | :--- | :--- |
| `POST /api/v1/merchants` (内部) | 钱包APP/商服平台、外部商户入驻流程 | 创建或同步收单商户（总部/门店）信息，并关联账户。 |
| `POST /api/v1/relationships/{type}` (内部) | 钱包APP/商服平台 | 创建各类分账业务关系（归集、批量付款、会员结算）的配置。 |
| `POST /internal/v1/instructions/split` (内部) | 业务核心、外部交易系统 | 接收交易信息，根据规则生成分账指令并路由至账务核心。 |

### 4.2.4 账务核心系统
| 接口路径与方法 | 调用方模块 | 功能说明 |
| :--- | :--- | :--- |
| `POST /internal/v1/transfers/async-notify` (内部) | 行业钱包系统 | 接收行业钱包系统分账执行结果异步通知，更新交易状态并记账。 |
| `GET /internal/v1/transfers/by-biz-no` (内部) | 业务核心、对账单系统 | 根据业务订单号查询关联的分账交易。 |

### 4.2.5 行业钱包系统
| 接口路径与方法 | 调用方模块 | 功能说明 |
| :--- | :--- | :--- |
| `POST /api/v1/transfers/tiancai-split` (内部) | 账务核心系统 | **核心资金划转接口**。执行分账资金在不同账户间的实际划转。 |
| `POST /api/v1/validations/relationship` (内部) | 账务核心系统 | 在执行分账前，快速校验付款方与收款方账户间的业务关系是否有效。 |
| `POST /internal/v1/callback/success` (内部) | 业务核心 | 分账成功后，回调业务核心记录最终成功的业务流水。 |

### 4.2.6 业务核心
| 接口路径与方法 | 调用方模块 | 功能说明 |
| :--- | :--- | :--- |
| `POST /api/v1/internal/statement-data` (内部) | 对账单系统 | 为对账单系统提供指定时间范围、商户、账户维度的原始成功交易数据。 |
| `GET /api/v1/internal/accounts/{accountNo}/records` (内部) | 对账单系统、钱包APP | 获取指定账户在特定时间范围内的所有交易记录，用于账单生成或前端展示。 |

### 4.2.7 清结算系统
| 接口路径与方法 | 调用方模块 | 功能说明 |
| :--- | :--- | :--- |
| `POST /api/v1/internal-accounts` (内部) | 账户系统、初始化流程 | 创建内部会计账户（如待结算账户01、退货账户04）。 |
| `GET /internal/v1/settlement-records` (内部) | 对账单系统 | 为对账单系统提供清结算流水数据。 |

### 4.2.8 消息通信 (异步)
| 通信方式 | 生产方模块 | 消费方模块 | 消息内容说明 |
| :--- | :--- | :--- | :--- |
| **MQ消息** | 账务核心系统 | 业务核心、对账单系统 | 分账交易状态变更通知（如成功、失败）。 |
| **MQ消息** | 行业钱包系统 | 账务核心系统 | 分账资金划转执行结果通知。 |
| **MQ消息** | 认证系统 | 钱包APP/商服平台 | 关系绑定认证进度更新通知（如待打款验证、待签约、已生效）。 |
| **MQ消息** | 电子签约平台 | 认证系统、钱包APP | 协议签署状态更新通知（如已签署、已拒签、已过期）。 |
| **MQ消息** | 对账单系统 | 通知服务 | 账单生成完成通知，触发邮件、站内信推送。 |