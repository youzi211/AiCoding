# 天财分账系统 - 系统级设计文档

## 2.1 系统结构

本系统采用分层、模块化的微服务架构，旨在为“天财”业务场景提供安全、合规、高效的资金流转与分账服务。整体架构遵循“高内聚、低耦合”原则，核心业务逻辑与底层金融基础设施解耦，通过清晰的接口契约进行交互。

### 架构图 (C4 Container Diagram)

```mermaid
graph TB
    subgraph "外部系统/用户"
        U1[商户/用户]
        U2[天财商龙]
        U3[支付系统]
        U4[短信网关/CA机构]
        U5[文件存储/对象存储]
    end

    subgraph "业务接入层"
        APP[钱包APP/商服平台]
    end

    subgraph "业务核心层"
        CORE[业务核心]
        AUTH[认证系统]
        FEE[计费中台]
        GEN3[三代系统]
    end

    subgraph "金融服务层"
        WALLET[行业钱包系统]
        ACCOUNT[账户系统]
        SETTLE[清结算系统]
        SIGN[电子签章系统]
        STATEMENT[对账单系统]
    end

    subgraph "外部依赖层"
        EXT1[电子签约平台]
        EXT2[第三方存证平台]
    end

    %% 外部交互
    U1 --> APP
    U2 --> GEN3
    U3 --> AUTH & SETTLE
    U4 --> SIGN
    U5 --> STATEMENT & SIGN

    %% 业务层内部交互
    APP --> GEN3 & AUTH & WALLET
    CORE --> WALLET & AUTH & FEE & GEN3
    AUTH --> GEN3 & SIGN & WALLET
    GEN3 --> WALLET & AUTH

    %% 服务层内部交互
    WALLET --> ACCOUNT & AUTH & FEE & GEN3
    SETTLE --> ACCOUNT & CORE & FEE & GEN3
    STATEMENT --> ACCOUNT & SETTLE & CORE & WALLET
    SIGN --> AUTH

    %% 外部依赖
    AUTH -.-> EXT1
    SIGN -.-> EXT1 & EXT2
```

**架构说明**:
*   **业务接入层**: 作为统一入口，面向商户和合作伙伴，封装复杂的业务流程，提供友好的交互界面和API。
*   **业务核心层**: 包含业务规则处理、流程编排、关系管理与计费的核心引擎，是业务逻辑的集中地。
*   **金融服务层**: 提供原子化的金融基础能力，如账户操作、资金划转、清算结算、电子签约和账单服务，确保金融操作的准确性、安全性和可审计性。
*   **外部依赖层**: 集成第三方专业服务，以增强系统在合规、存证等方面的能力。

## 2.2 功能结构

系统功能围绕“账户-认证-交易-结算-对账”的核心资金流转链路进行组织。

### 功能结构图

```mermaid
graph TD
    Root[天财分账系统] --> F1[商户与账户管理]
    Root --> F2[关系与认证管理]
    Root --> F3[资金流转处理]
    Root --> F4[清算与结算]
    Root --> F5[对账与审计]
    Root --> F6[系统支撑]

    F1 --> F1.1[商户信息管理]
    F1 --> F1.2[账户全生命周期管理]
    F1 --> F1.3[账户关系绑定]

    F2 --> F2.1[关系绑定流程]
    F2 --> F2.2[身份认证与协议签署]
    F2 --> F2.3[付款权限开通]

    F3 --> F3.1[分账/转账]
    F3 --> F3.2[批量付款]
    F3 --> F3.3[交易冲正]
    F3 --> F3.4[手续费计算]

    F4 --> F4.1[结算指令生成]
    F4 --> F4.2[资金划拨执行]
    F4 --> F4.3[日终批处理]

    F5 --> F5.1[交易流水对账]
    F5 --> F5.2[多维度账单生成]
    F5 --> F5.3[操作审计日志]

    F6 --> F6.1[规则引擎]
    F6 --> F6.2[任务调度]
    F6 --> F6.3[文件服务]
```

**功能模块说明**:
1.  **商户与账户管理**: 以`三代系统`为权威数据源，管理商户实体及其`天财专用账户`的创建、绑定、状态维护。
2.  **关系与认证管理**: 由`认证系统`主导，确保资金流转双方（如品牌方与加盟商）关系的合法性，通过电子签约完成授权认证。
3.  **资金流转处理**: `业务核心`作为处理引擎，调用`行业钱包系统`和`账户系统`执行具体的分账、归集、批量付款等操作，并联动`计费中台`实时计算费用。
4.  **清算与结算**: `清结算系统`负责交易后的资金清分、轧差，并生成结算指令，驱动`账户系统`完成最终的出金操作。
5.  **对账与审计**: `对账单系统`聚合全链路流水，提供多维度视图。各模块的审计表（如`auth_audit_log`, `sign_audit_log`）记录关键操作，满足合规要求。
6.  **系统支撑**: 贯穿各模块的支撑能力，如`计费中台`的规则引擎、各模块的异步任务处理、文件导出与存储等。

## 2.3 网络拓扑图

系统部署在私有云或金融云环境，采用典型的微服务网络分区拓扑，确保安全隔离与性能。

```mermaid
graph TB
    subgraph "互联网区 (DMZ)"
        LB[负载均衡器/API Gateway]
        WAF[Web应用防火墙]
    end

    subgraph "应用服务区"
        subgraph "业务服务集群"
            APP_Node[钱包APP]
            CORE_Node[业务核心]
            AUTH_Node[认证系统]
            GEN3_Node[三代系统]
        end
        subgraph "金融服务集群"
            WALLET_Node[行业钱包]
            ACCOUNT_Node[账户系统]
            SETTLE_Node[清结算]
            FEE_Node[计费中台]
            SIGN_Node[电子签章]
            STMT_Node[对账单]
        end
    end

    subgraph "数据存储区"
        subgraph "业务数据库集群"
            DB1[(业务库)]
        end
        subgraph "账务数据库集群"
            DB2[(账务核心库)]
        end
        Cache[缓存集群]
        MQ[消息队列集群]
        FS[文件存储服务]
    end

    subgraph "外部服务区"
        PS[支付/清结算系统]
        CA[CA/电子签约平台]
        SMS[短信网关]
    end

    %% 流量走向
    Internet --> WAF --> LB
    LB --> APP_Node & CORE_Node & AUTH_Node & GEN3_Node

    %% 应用区内部通信 (通常通过服务网格或内部LB)
    APP_Node --> CORE_Node & AUTH_Node & GEN3_Node
    CORE_Node --> WALLET_Node & FEE_Node
    AUTH_Node --> SIGN_Node & GEN3_Node
    GEN3_Node --> WALLET_Node
    WALLET_Node --> ACCOUNT_Node
    SETTLE_Node --> ACCOUNT_Node & CORE_Node

    %% 应用与数据区通信
    业务服务集群 --> DB1 & Cache & MQ
    金融服务集群 --> DB2 & Cache & MQ
    STMT_Node & SIGN_Node --> FS

    %% 外部服务调用
    SIGN_Node -.-> CA & SMS
    AUTH_Node & SETTLE_Node -.-> PS
```

**拓扑说明**:
*   **安全分层**: 严格划分互联网区、应用服务区、数据存储区和外部服务区，通过防火墙策略控制访问。
*   **服务分组**: 将业务服务与对一致性、准确性要求极高的金融服务（特别是`账户系统`）进行逻辑或物理集群隔离，降低相互影响。
*   **数据隔离**: `业务数据库`与`账务核心数据库`分离，符合金融系统设计规范，保障核心账务数据的安全与性能。
*   **异步通信**: 广泛使用消息队列（MQ）解耦耗时操作（如批量处理、账单生成、异步通知），提升系统响应能力和可靠性。

## 2.4 数据流转

数据流转围绕“交易发起 -> 业务校验 -> 资金操作 -> 清算结算 -> 账单生成”的主线进行。

### 核心资金流转数据流图 (DFD)

```mermaid
flowchart TD
    A[天财商龙/商户] -->|1. 发起分账请求| B[三代系统]
    B -->|2. 校验业务关系| B
    B -->|3. 转发请求| C[业务核心]
    C -->|4. 查询/缓存关系| D[认证系统]
    C -->|5. 计算手续费| E[计费中台]
    C -->|6. 调用资金划转| F[行业钱包系统]
    F -->|7. 执行原子化账务操作| G[账户系统]
    G -->|8. 记录流水| G
    F -->|9. 返回结果| C
    C -->|10. 记录交易| C
    C -->|11. 异步通知结算| H[清结算系统]
    H -->|12. 生成结算指令| H
    H -->|13. 执行资金结算| G
    G -->|14. 记录结算流水| G
    G & C & H -->|15. 同步流水数据| I[对账单系统]
    I -->|16. 聚合生成账单| I
```

**关键数据流说明**:
1.  **交易指令流**: 请求依次经过`三代系统`（业务控制）-> `业务核心`（引擎）-> `行业钱包系统`（桥梁）-> `账户系统`（基石），完成资金在账户间的转移。
2.  **控制与校验流**: `业务核心`在处理前后需与`认证系统`确认关系有效性，与`计费中台`确定费用，确保交易合规。
3.  **结算流**: 交易完成后，`清结算系统`作为后续环节，从`业务核心`或`支付系统`获取待结算数据，组织并驱动`账户系统`完成向外部银行账户的出金。
4.  **数据聚合流**: `账户系统`的流水、`业务核心`的交易记录、`清结算系统`的结算明细，作为源数据被`对账单系统`近乎实时或定时抽取，加工成面向用户的对账单。

## 2.5 系统模块交互关系

模块间通过RESTful API或RPC进行同步调用，并通过消息事件进行异步解耦。

### 模块依赖与交互图

```mermaid
graph LR
    %% 定义节点
    ACC[账户系统]
    AUTH[认证系统]
    FEE[计费中台]
    GEN3[三代系统]
    CORE[业务核心]
    SETTLE[清结算系统]
    SIGN[电子签章系统]
    WALLET[行业钱包系统]
    APP[钱包APP/商服平台]
    STMT[对账单系统]

    %% 核心依赖关系 (箭头方向: 依赖方 -> 被依赖方)
    AUTH --> GEN3 & WALLET & SIGN & ACC
    CORE --> WALLET & ACC & FEE & AUTH
    FEE --> CORE
    GEN3 --> WALLET & ACC
    SETTLE --> ACC & CORE & FEE & GEN3
    SIGN --> AUTH
    WALLET --> ACC & AUTH & FEE & GEN3
    APP --> GEN3 & AUTH & WALLET & ACC & SETTLE
    STMT --> ACC & SETTLE & CORE & WALLET

    %% 突出核心枢纽
    style ACC fill:#e1f5fe
    style CORE fill:#f3e5f5
    style WALLET fill:#f1f8e9
```

**关键交互关系详述**:

| 依赖方 | 被依赖方 | 交互场景 | 接口示例 |
| :--- | :--- | :--- | :--- |
| **业务核心** | **行业钱包系统** | 执行所有分账、转账等资金操作。 | `POST /wallet/transfers/execute` |
| **行业钱包系统** | **账户系统** | 执行底层的原子化资金记账（入账、出账、冻结）。 | `POST /accounts/transactions` (内部) |
| **认证系统** | **电子签章系统** | 在关系绑定或开通付款时，创建并跟踪电子协议签署任务。 | `POST /sign/tasks` |
| **三代系统** | **账户系统** | 为商户申请或升级“天财专用账户”。 | `POST /accounts`, `POST /accounts/{id}/upgrade-to-tiancai` |
| **清结算系统** | **账户系统** | 执行结算指令，将资金从内部账户划拨至商户银行卡。 | `POST /accounts/transactions` (内部) |
| **钱包APP/商服平台** | **三代系统** | 查询商户权威信息、发起业务关系建立请求。 | `POST /business-relationships` |
| **所有资金相关模块** | **对账单系统** | 提供交易、流水、结算明细等原始数据。 | (通过消息或DB同步) |
| **计费中台** | **业务核心** | 为每笔交易实时计算手续费及承担方。 | `POST /fee/calculate` |

**设计原则**:
*   **单向依赖**: 架构上避免循环依赖，特别是金融底层模块（如`账户系统`）不反向依赖上层业务模块。
*   **接口明晰**: `账户系统`对内部模块提供原子操作接口；`行业钱包系统`封装业务语义更强的资金操作。
*   **事件驱动**: 交易状态更新、结算完成等事件通过消息通知相关方（如`对账单系统`），降低系统耦合度。