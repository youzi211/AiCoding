# 批判日志: 计费中台

## 批判迭代 #1 - 2026-01-21 18:10:52

**模块**: 计费中台

**分数**: 0.10 / 1.0

**结果**: ❌ 未通过


### 发现的问题

- 接口设计为空（API端点、请求响应结构、事件发布消费均为TBD），无法评审对接方式、幂等、鉴权、错误码与版本策略。
- 数据模型为空（表/集合、关键字段均为TBD），无法评审计费结果如何持久化、如何对账追溯、如何支持重放与审计。
- 依赖关系表述与上下游定义不一致：在数据模型中写为依赖账户系统并同步清结算，但在依赖关系章节将账户系统标为上游模块（查询账户信息）。需明确账户系统是被调用依赖（下游依赖）还是事件上游，并统一术语。
- 核心业务逻辑缺少关键输入与规则维度定义：未明确交易类型枚举、场景（归集/批量付款/会员结算）与费率策略的映射、到账模式（净额/全额）对手续费承担与入账金额的影响。
- 缺少幂等与一致性设计：未说明计费请求的幂等键（如交易单号）与重复请求处理；未说明向清结算同步的至少一次投递下如何去重与补偿。
- 错误处理不够可执行：仅描述重试或降级，未定义哪些错误可重试、重试策略（次数/退避）、降级行为（返回默认费率或拒绝交易）以及与对账的补偿流程。
- 边界情况覆盖不足：仅列出费率为零、溢出、规则未找到，缺少金额精度与舍入规则、币种支持、最小/最大手续费封顶封底、负数或超限金额校验、账户信息缺失或状态异常处理。
- 同步清结算的数据契约缺失：未定义同步字段（手续费金额、承担方、原交易标识、计费规则版本、计算明细）、同步时机（同步成功是否影响对上游返回）与失败后的重试/补偿机制。


### 改进建议
补齐可落地的接口与数据契约：1）定义REST端点（如POST /fees/quote与POST /fees/settlement-sync或事件主题），给出请求字段（交易单号、场景、交易类型、金额、币种、手续费承担方、付方/收方账户标识、到账模式等）、响应字段（手续费、净额/全额、规则版本、明细）与标准错误码；2）设计持久化模型（计费请求表、计费结果表、同步出站表outbox），包含幂等键、状态机、规则版本、时间戳与审计字段；3）明确依赖方向与调用方式（账户系统为被调用依赖还是事件上游），统一术语；4）补充规则引擎维度与算法细节（舍入、封顶封底、精度、币种、异常输入校验），并给出各场景的费率策略映射；5）补齐一致性方案（幂等、去重、outbox+重试、补偿与对账），明确同步清结算失败时的处理与SLA；6）将错误处理细化为可执行策略（可重试错误清单、退避、熔断、降级行为与告警指标）。

---

