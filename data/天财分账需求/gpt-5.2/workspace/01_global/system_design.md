## 2.1 系统结构
本系统采用分层架构，旨在为"天财"业务平台提供分账、会员结算、批量付款等资金处理能力。整体架构分为接入层、业务层、核心服务层和基础服务层，各层职责清晰，通过API进行松耦合交互。

- **接入层**：接收来自天财平台的业务请求，进行协议转换、路由和初步校验。
- **业务层**：包含"业务核心"模块，作为业务流程的编排中心，负责协调下游服务完成复杂的业务逻辑，如分账、结算、关系绑定等。
- **核心服务层**：包含处理核心领域能力的模块，如"行业钱包"（用户与账户关系）、"清结算"（资金结算与冻结）、"账户系统"（资金操作）、"账务核心"（账务记录）。
- **基础服务层**：提供通用能力支撑，如"计费中台"（手续费计算）、"电子签约平台"（协议签署）、"认证系统"（身份验证）、"风控"（风险控制）、"对账单系统"（对账文件生成）。

系统架构图如下：

```mermaid
flowchart TD
    subgraph A[接入层]
        A1[天财平台]
    end

    subgraph B[业务层]
        B1[业务核心]
    end

    subgraph C[核心服务层]
        C1[行业钱包]
        C2[清结算]
        C3[账户系统]
        C4[账务核心]
    end

    subgraph D[基础服务层]
        D1[计费中台]
        D2[电子签约平台]
        D3[认证系统]
        D4[风控]
        D5[对账单系统]
        D6[三代]
    end

    A1 -- 分账/结算等业务请求 --> B1

    B1 -- 协调业务流 --> C1
    B1 -- 协调业务流 --> C2
    B1 -- 协调业务流 --> C3
    B1 -- 协调业务流 --> D1
    B1 -- 协调业务流 --> D6

    C1 -- 调用账户操作 --> C3
    C2 -- 调用记账 --> C4
    C2 -- 调用账户操作 --> C3
    C2 -- 请求计费 --> D1
    C3 -- 调用记账 --> C4

    D2 -- 调用验证 --> D3
    D4 -- 发起冻结 --> C2
    D5 -- 拉取数据 --> B1
    D5 -- 拉取数据 --> C2
    D5 -- 拉取数据 --> C4
    D6 -- 同步商户信息 --> C1
```

## 2.2 功能结构
系统功能围绕"天财"资金业务展开，主要划分为账户管理、资金处理、业务支撑、风险与对账四大功能域。

- **账户管理域**：负责商户与账户的生命周期管理，包括开户、信息同步、关系绑定与授权。
- **资金处理域**：负责核心的资金流转操作，包括分账、结算、归集、批量付款、提现及相关的计费处理。
- **业务支撑域**：为业务流程提供必要的通用服务，包括身份认证、电子签约、商户审核与配置。
- **风险与对账域**：负责系统风险控制及事后的账务核对，包括交易/商户冻结、对账单生成。

功能结构图如下：

```mermaid
flowchart TD
    Root[天财资金处理系统]

    subgraph F1[账户管理域]
        F1_1[开户管理]
        F1_2[账户关系绑定]
        F1_3[结算模式配置]
    end

    subgraph F2[资金处理域]
        F2_1[分账处理]
        F2_2[结算处理]
        F2_3[归集处理]
        F2_4[批量付款]
        F2_5[提现处理]
        F2_6[手续费计算]
    end

    subgraph F3[业务支撑域]
        F3_1[身份认证]
        F3_2[电子签约]
        F3_3[商户审核与同步]
    end

    subgraph F4[风险与对账域]
        F4_1[交易/商户冻结]
        F4_2[对账单生成]
    end

    Root --> F1
    Root --> F2
    Root --> F3
    Root --> F4

    F1_1 --> F1_2
    F1_3 --> F2_2
    F2_1 --> F2_2
    F2_2 --> F2_6
    F3_1 --> F3_2
    F3_2 --> F1_2
    F4_1 -.-> F2_2
```

## 2.3 网络拓扑图
TBD

## 2.4 数据流转
系统内关键业务数据（如交易请求、账户指令、账务记录）在模块间按特定顺序流转，以完成一个完整的业务闭环。以"分账"业务为例，数据流转主要经过业务受理、业务校验、资金结算、账务记录四个阶段。

1.  **业务受理**：天财平台发起请求至业务核心。
2.  **业务校验**：业务核心调用行业钱包进行业务规则校验。
3.  **资金结算**：业务核心或行业钱包驱动清结算流程，清结算协调计费中台计算手续费，并调用账户系统完成资金划转。
4.  **账务记录**：账户系统调用账务核心记录资金变动分录。最终，对账单系统从各数据源拉取数据生成对账文件。

数据流图如下：

```mermaid
flowchart LR
    A[天财平台] -->|1. 分账请求| B[业务核心]
    B -->|2. 业务校验请求| C[行业钱包]
    C -->|3. 校验结果| B
    B -->|4. 结算指令| D[清结算]
    D -->|5. 计费请求| E[计费中台]
    E -->|6. 计费结果| D
    D -->|7. 资金划转指令| F[账户系统]
    F -->|8. 记账请求| G[账务核心]
    G -->|9. 记账结果| F
    F -->|10. 操作结果| D
    D -->|11. 结算结果| B
    B -->|12. 处理结果| A

    H[对账单系统] -->|13. 拉取交易数据| B
    H -->|14. 拉取结算数据| D
    H -->|15. 拉取账务数据| G
```

## 2.5 系统模块交互关系
各系统模块通过API调用、事件通知等方式进行协作，形成清晰的依赖关系。业务核心作为主要协调者，行业钱包、清结算、账户系统作为核心领域服务，其他模块提供专项能力支撑。

关键交互关系包括：
- **业务核心**：作为总协调者，依赖行业钱包、清结算、计费中台、账户系统、三代等完成业务流程。
- **行业钱包**：依赖账户系统进行开户，依赖电子签约平台完成关系绑定。
- **清结算**：依赖计费中台计算费用，依赖账户系统操作资金，依赖账务核心完成记账。
- **账户系统**：是资金操作的执行者，最终依赖账务核心记录所有变动。
- **风控**：依赖清结算和账户系统执行冻结操作。
- **对账单系统**：依赖业务核心、清结算、账务核心提供数据源。

模块交互图如下：

```mermaid
flowchart TD
    TC[天财平台]
    Biz[业务核心]
    Wallet[行业钱包]
    Settle[清结算]
    Acct[账户系统]
    Ledger[账务核心]
    Fee[计费中台]
    Sign[电子签约平台]
    Auth[认证系统]
    Risk[风控]
    Stmt[对账单系统]
    Third[三代]

    TC --> Biz
    Biz --> Wallet
    Biz --> Settle
    Biz --> Fee
    Biz --> Third
    Wallet --> Acct
    Wallet --> Sign
    Settle --> Fee
    Settle --> Acct
    Settle --> Ledger
    Acct --> Ledger
    Sign --> Auth
    Risk --> Settle
    Risk --> Acct
    Stmt --> Biz
    Stmt --> Settle
    Stmt --> Ledger
    Third --> Wallet
```