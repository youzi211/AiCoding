# 模块设计: 用户中心

生成时间: 2026-01-22 17:47:01
批判迭代: 2

---

# 用户中心模块设计文档

## 1. 概述
- **目的与范围**: 用户中心模块负责生成和管理系统内的用户唯一标识（userid）。其核心职责是为所有业务实体（如收单商户、非收单商户、个人等）提供全局唯一的身份标识，作为关联账户、交易、关系绑定等业务数据的核心索引。其边界限定于用户标识的生成、查询与管理，不涉及具体的账户、资金或业务逻辑处理。

## 2. 接口设计
- **API端点 (REST/GraphQL)**:
    - `POST /v1/users`: 创建用户标识。请求方需提供来源系统标识和外部业务唯一标识。
    - `GET /v1/users/{userid}`: 根据用户标识查询用户信息。
    - `GET /v1/users`: 根据来源系统标识和外部业务唯一标识查询用户标识（幂等性查询）。
- **请求/响应结构**:
    - 创建请求: `{“source_system”: “string”, “external_ref”: “string”}`
    - 创建响应: `{“userid”: “string”, “created_at”: “timestamp”}`
    - 查询响应: `{“userid”: “string”, “source_system”: “string”, “external_ref”: “string”, “created_at”: “timestamp”}`
- **发布/消费的事件**: TBD

## 3. 数据模型
- **表/集合**: `user_identifiers`
- **关键字段**:
    - `userid` (主键): 全局唯一的用户标识，字符串类型。
    - `source_system`: 来源系统标识（如“merchant-service”、“wallet-core”），用于区分调用方。
    - `external_ref`: 外部业务唯一标识（如商户号、个人证件号），与`source_system`组成联合唯一约束。
    - `created_at`: 记录创建时间戳。
- **与其他模块的关系**: 用户中心生成的 `userid` 将被行业钱包、账户系统、业务核心等下游模块引用，作为关联用户、账户和交易记录的关键字段。

## 4. 业务逻辑
- **核心工作流/算法**:
    1. **唯一ID生成算法**: 采用雪花算法（Snowflake）生成分布式唯一ID。ID结构包含时间戳、数据中心ID、工作节点ID和序列号，确保在分布式环境下全局唯一、趋势递增。
    2. **创建流程**: 接收创建请求后，首先根据`source_system`和`external_ref`查询是否已存在记录。若存在，则直接返回已有的`userid`，确保幂等性。若不存在，则生成新的雪花ID，并尝试插入数据库。若因唯一约束冲突导致插入失败，则重新生成ID并重试（最多重试3次）。
- **业务规则与验证**:
    1. 生成的 `userid` 必须全局唯一。
    2. 对于同一业务实体（由`source_system` + `external_ref`唯一确定），必须保证返回的`userid`稳定且一致。
    3. 请求必须包含有效的`source_system`和`external_ref`参数。
- **关键边界情况处理**:
    1. **高并发ID生成**: 雪花算法的时间戳和序列号机制能有效支持高并发生成。工作节点ID需正确配置以避免冲突。
    2. **幂等性保证**: 通过`source_system`和`external_ref`的联合唯一索引，确保同一业务请求总是返回相同`userid`。
    3. **数据库写入冲突**: 尽管有唯一索引和雪花算法，极端情况下仍可能发生主键冲突。此时捕获唯一约束异常，进行有限次数的重试。

## 5. 时序图

```mermaid
sequenceDiagram
    participant 调用方 as 调用方服务(如商户服务)
    participant 用户中心
    participant DB as 用户标识存储

    调用方->>用户中心: POST /v1/users
    Note over 用户中心: 参数: source_system, external_ref
    用户中心->>DB: 根据(source_system, external_ref)查询
    alt 记录已存在
        DB-->>用户中心: 返回已存在userid
        用户中心-->>调用方: 200 OK，返回已有userid
    else 记录不存在
        用户中心->>用户中心: 生成雪花算法ID
        loop 最多重试3次
            用户中心->>DB: 插入新记录(userid, source_system, external_ref)
            alt 插入成功
                DB-->>用户中心: 确认
                用户中心-->>调用方: 201 Created，返回新userid
                break
            else 主键冲突
                DB-->>用户中心: 唯一约束错误
                用户中心->>用户中心: 重新生成ID
            end
        end
        opt 重试全部失败
            用户中心-->>调用方: 500 系统错误
        end
    end
```

## 6. 错误处理
- **预期错误情况**:
    1. **请求参数无效**: `source_system`或`external_ref`缺失或格式错误。
    2. **唯一ID冲突**: 雪花ID生成后，插入时发生主键冲突（极小概率事件）。
    3. **数据库错误**: 连接失败、写入失败等系统级错误。
    4. **幂等性冲突**: 并发请求下，对同一`source_system`和`external_ref`同时发起创建请求。
- **处理策略**:
    1. 参数无效返回 `400 Bad Request` 及具体错误信息。
    2. ID冲突触发内部重试机制（最多3次），若全部失败则返回 `500 Internal Server Error`。
    3. 数据库错误记录详细日志，并向上游返回 `503 Service Unavailable`。
    4. 幂等性冲突由数据库唯一索引保证，后到达的请求会因插入失败而触发查询逻辑，最终返回已创建的`userid`。

## 7. 依赖关系
- **上游模块/服务**: 本模块由扮演“三代”和“行业钱包”角色的具体服务调用，例如“商户服务”（负责商户开户审核）、“钱包核心服务”（负责账户开户）。这些服务通过调用 `POST /v1/users` 接口为其管理的业务实体申请唯一标识。
- **下游模块**: 行业钱包、账户系统、业务核心等模块依赖本模块提供的 `userid` 来关联其各自的业务数据。它们通过 `userid` 查询或关联用户相关的账户、交易等信息。