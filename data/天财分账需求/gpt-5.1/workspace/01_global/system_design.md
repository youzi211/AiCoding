# 天财分账业务系统级设计文档

## 2.1 系统结构

天财分账业务系统采用分层、模块化的微服务架构，旨在为天财商龙合作方提供合规、高效、可追溯的资金分账服务。系统以**三代系统**作为统一对外接口和业务协调中心，以**行业钱包系统**为核心业务逻辑处理引擎，底层依赖**账户系统**、**清结算系统**等基础金融能力，并通过**电子签章**与**认证系统**确保业务关系的真实合法。整体架构遵循高内聚、低耦合原则，确保系统的可扩展性、可维护性和高可用性。

```mermaid
graph TB
    subgraph "外部系统与用户"
        A[天财商龙合作方]
        B[商户/用户<br>（钱包APP/商服平台）]
        C[第三方服务<br>（人脸识别/短信/OSS）]
    end

    subgraph "业务接入与协调层"
        D[三代系统<br>（唯一对外接口/业务协调）]
    end

    subgraph "核心业务处理层"
        E[行业钱包系统<br>（天财分账专项）]
        F[认证系统]
        G[电子签章系统]
        H[计费中台]
    end

    subgraph "基础服务与数据层"
        I[账户系统]
        J[清结算系统]
        K[账务核心系统]
        L[业务核心]
    end

    subgraph "数据消费与呈现层"
        M[对账单系统]
        N[前端渠道]
    end

    A -- 业务请求/查询 --> D
    B -- 登录/查询/操作 --> N
    N -- 数据请求 --> D
    D -- 协调业务流 --> E
    E -- 账户操作 --> I
    E -- 计费请求 --> H
    E -- 签约请求 --> G
    E -- 认证请求 --> F
    E -- 交易记录 --> L
    F -- 人脸验证 --> C
    G -- 短信发送/证据存储 --> C
    H -- 同步规则 --> D
    H -- 扣费指令 --> J
    J -- 账户操作/结算 --> I
    K -- 记录交易 --> I
    L -- 提供数据 --> M
    M -- 查询数据 --> I & L & J & D
```

**架构说明**:
1.  **外部接入层**: 三代系统作为唯一入口，屏蔽内部复杂度，提供稳定API。
2.  **核心业务层**: 行业钱包系统串联开户、绑关系、分账等核心流程，依赖认证、签章、计费等专项服务完成特定环节。
3.  **基础服务层**: 提供账户、清算、记账等金融系统核心能力，是资金安全、准确流转的基石。
4.  **数据层**: 业务核心与账务核心分别记录业务与账务数据，为对账单系统提供可靠数据源。
5.  **呈现层**: 对账单系统满足机构对账需求，前端渠道为商户提供自助服务。

## 2.2 功能结构

系统功能围绕“天财分账”业务的生命周期进行组织，涵盖商户准入、关系建立、交易执行、资金结算及数据服务全流程。

```mermaid
graph TD
    A[天财分账业务系统] --> B1[商户与账户管理]
    A --> B2[分账关系管理]
    A --> B3[分账交易执行]
    A --> B4[资金清算结算]
    A --> B5[对账与数据服务]
    A --> B6[系统支撑功能]

    B1 --> C1[天财账户开通]
    B1 --> C2[账户状态管理]
    B1 --> C3[账户信息查询]

    B2 --> C4[分账关系绑定]
    B2 --> C5[代付授权开通]
    B2 --> C6[关系状态查询]

    B3 --> C7[分账指令处理]
    B3 --> C8[实时手续费计算]
    B3 --> C9[交易记录与存储]

    B4 --> C10[结算账户配置]
    B4 --> C11[手续费扣划]
    B4 --> C12[资金冻结解冻]
    B4 --> C13[结算明细处理]

    B5 --> C14[交易数据查询]
    B5 --> C15[账单生成与下载]
    B5 --> C16[资金流水查询]

    B6 --> C17[电子签约与认证]
    B6 --> C18[费率规则管理]
    B6 --> C19[风控与审计]
    B6 --> C20[前端渠道服务]
```

**功能模块说明**:
- **商户与账户管理**: 负责天财专用账户的创建、升级、状态维护与查询，是业务参与方的准入基础。
- **分账关系管理**: 通过电子签约、小额打款/人脸认证建立并管理付方与收方之间的分账授权关系。
- **分账交易执行**: 处理归集、批量付款、会员结算等场景下的资金划转，协调计费并记录交易。
- **资金清算结算**: 执行资金的实际清算、手续费扣收、账户冻结及结算到银行卡等操作。
- **对账与数据服务**: 整合多源数据，为天财机构提供交易明细、汇总账单及资金流水查询。
- **系统支撑功能**: 提供签约、认证、计费规则、风控、前端交互等支撑业务运行的必要能力。

## 2.3 网络拓扑图

系统部署在私有云或金融级云平台内，采用分区隔离策略，确保不同安全等级模块间的访问可控。外部访问通过API网关接入，内部服务间通过服务网格或内网负载均衡进行通信。

```mermaid
graph TB
    subgraph "DMZ区 / 互联网接入区"
        GW[API网关]
        FW1[外部防火墙]
    end

    subgraph "应用服务区"
        subgraph "业务服务集群"
            S1[三代系统]
            S2[行业钱包系统]
            S3[计费中台]
            S4[对账单系统]
            S5[前端渠道服务]
        end
        subgraph "基础服务集群"
            S6[账户系统]
            S7[清结算系统]
            S8[账务核心系统]
            S9[业务核心系统]
        end
        subgraph "安全与认证集群"
            S10[认证系统]
            S11[电子签章系统]
        end
        LB[内部负载均衡器]
    end

    subgraph "数据存储区"
        DB1[(业务数据库集群)]
        DB2[(账务数据库集群)]
        DB3[(缓存集群)]
        MQ[消息中间件集群]
        FW3[数据层防火墙]
    end

    subgraph "外部服务区"
        Ext1[第三方人脸识别]
        Ext2[短信网关]
        Ext3[对象存储 OSS]
    end

    Internet -- HTTPS --> FW1 --> GW
    GW -- 路由/限流 --> LB
    LB -- 内部调用 --> S1 & S2 & S3 & S4 & S5 & S6 & S7 & S8 & S9 & S10 & S11

    S1 & S2 & S3 & S4 & S5 & S6 & S7 & S8 & S9 & S10 & S11 -- 数据持久化/缓存/消息 --> FW3 --> DB1 & DB2 & DB3 & MQ
    
    S10 -- 安全通道 --> Ext1
    S11 -- 安全通道 --> Ext2 & Ext3
```

**部署说明**:
1.  **安全隔离**: 网络分为DMZ区、应用区、数据区，通过防火墙严格管控流量。
2.  **高可用**: 关键服务与中间件均采用集群部署，消除单点故障。
3.  **外部集成**: 与第三方服务通过专线或VPN建立安全、稳定的连接。
4.  **内部通信**: 服务间通过内网域名和负载均衡器调用，保证高效与可靠。

## 2.4 数据流转

数据流转核心围绕“一笔分账交易”的生命周期展开，涉及业务数据、资金指令和账务记录在多系统间的传递与同步。

```mermaid
flowchart TD
    A[天财商龙] -- 1. 发起分账请求 --> B(三代系统)
    B -- 2. 协调业务逻辑 --> C(行业钱包系统)
    C -- 3. 计算手续费 --> D(计费中台)
    D -- 4. 返回费用 --> C
    C -- 5. 调用账户记账 --> E(账户系统)
    E -- 6. 记录账户流水 --> E
    C -- 7. 发送交易记录 --> F(业务核心)
    F -- 8. 持久化交易数据 --> F
    C -- 9. 通知清结算 --> G(清结算系统)
    G -- 10. 执行手续费扣划 --> E
    G -- 11. 触发结算（T+1） --> E
    F -- 12. 提供交易数据 --> H(对账单系统)
    E -- 13. 提供账户流水数据 --> H
    G -- 14. 提供结算明细数据 --> H
    H -- 15. 合成账单 --> H
    H -- 16. 返回账单数据 --> A
```

**关键数据流说明**:
1.  **业务请求流**: 外部请求经三代系统路由至行业钱包系统，驱动核心业务流程。
2.  **资金处理流**: 行业钱包系统驱动账户系统完成实时记账，清结算系统在事后完成手续费扣划和资金结算。
3.  **数据记录流**: 交易数据由业务核心持久化，账户流水、结算明细由各自系统记录，共同构成完整的业务视图。
4.  **对账数据流**: 对账单系统作为数据消费者，从业务核心、账户系统、清结算系统拉取数据，加工后提供给天财机构。

## 2.5 系统模块交互关系

各模块通过清晰的接口契约进行协作，形成松耦合的依赖关系。下图展示了核心的业务交互场景。

```mermaid
graph LR
    subgraph "外部与接入"
        Ext[天财商龙]
        Front[前端渠道]
    end

    subgraph "业务处理核心"
        Gen3[三代系统]
        Wallet[行业钱包系统]
        Fee[计费中台]
        Auth[认证系统]
        Esign[电子签章系统]
    end

    subgraph "基础服务"
        Acct[账户系统]
        Stm[清结算系统]
        AcctCore[账务核心系统]
        BizCore[业务核心]
    end

    subgraph "数据服务"
        Stmt[对账单系统]
    end

    Ext -- 所有业务API调用 --> Gen3
    Front -- 查询类请求 --> Gen3

    Gen3 -- 账户/关系/分账指令 --> Wallet
    Gen3 -- 同步费率规则 --> Fee
    Gen3 -- 查询账单数据 --> Stmt

    Wallet -- 账户操作/记账 --> Acct
    Wallet -- 计费计算 --> Fee
    Wallet -- 发起签约 --> Esign
    Wallet -- 发起身份认证 --> Auth
    Wallet -- 记录交易完成 --> BizCore
    Wallet -- 触发结算 --> Stm

    Auth -- 小额打款记账 --> AcctCore
    Auth -- 签约流程关联 --> Esign

    Esign -- 签约完成回调 --> Wallet

    Fee -- 扣费指令 --> Stm

    Stm -- 账户冻结/扣划 --> Acct
    Stm -- 结算执行 --> Acct

    BizCore -- 提供交易数据查询 --> Stmt
    Acct -- 提供账户数据查询 --> Stmt
    Stm -- 提供结算数据查询 --> Stmt
```

**交互关系详解**:
- **三代系统**是枢纽，对外统一，对内协调，重度依赖**行业钱包系统**处理具体业务。
- **行业钱包系统**是业务流程的“总导演”，串联起**账户系统**（资金操作）、**认证/签章系统**（合规保障）、**计费中台**（费用计算）、**业务核心**（数据留存）和**清结算系统**（事后结算）。
- **认证系统**与**电子签章系统**协作，共同完成关系绑定的合规流程，并依赖**账务核心系统**完成小额打款。
- **对账单系统**是主要的数据消费者，从**业务核心**、**账户系统**、**清结算系统**和**三代系统**获取原始数据，加工后输出。
- **清结算系统**和**计费中台**作为资金处理的关键环节，最终通过**账户系统**完成所有资金变动。