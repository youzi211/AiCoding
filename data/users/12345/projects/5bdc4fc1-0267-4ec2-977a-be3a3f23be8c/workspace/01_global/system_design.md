## 2.1 系统结构
本系统采用分层架构，旨在为天财分账业务提供从外部接入、业务处理到底层账户操作的全链路支持。系统以三代作为核心接入与管控层，以行业钱包（分账核心）作为业务处理中枢，通过调用或协同多个内部专业系统（如账户系统、电子签约平台、认证系统等）完成开户、关系绑定、分账、结算等核心业务流程。整体架构遵循职责分离原则，确保各系统专注于其核心能力。

```mermaid
graph TB
    subgraph "外部接入层"
        T[天财合作方]
        W[钱包APP/商服平台]
    end

    subgraph "业务接入与管控层"
        G[三代系统]
    end

    subgraph "业务处理层"
        HW[行业钱包<br/>(分账核心)]
        ES[电子签约平台]
        AS[认证系统]
        FS[计费中台]
        TS[交易系统]
        BS[代付系统]
        BC[业务核心]
    end

    subgraph "核心服务层"
        ACS[账户系统]
        CL[清结算]
        AC[账务核心]
    end

    subgraph "数据与报表层"
        SS[对账单系统]
    end

    subgraph "基础服务层"
        P[交易系统<br/>(收单)]
    end

    T --> G
    W --> G
    G --> HW
    G --> ES
    G --> FS
    HW --> ACS
    HW --> ES
    HW --> AS
    HW --> FS
    HW --> CL
    HW --> BC
    HW --> SS
    ES --> AS
    TS --> HW
    TS --> ACS
    TS --> FS
    TS --> CL
    TS --> BC
    BS --> HW
    BS --> ES
    BS --> ACS
    BS --> FS
    BS --> CL
    BS --> BC
    ACS --> CL
    FS --> CL
    BC --> SS
    P --> BC
    ACS --> AC
```

## 2.2 功能结构
系统功能围绕天财分账业务的核心流程进行组织，主要划分为商户与账户管理、关系绑定与认证、分账交易处理、资金结算与清分、以及数据服务五大功能域。

```mermaid
graph TD
    Root[天财分账系统功能]

    Root --> A[商户与账户管理]
    Root --> B[关系绑定与认证]
    Root --> C[分账交易处理]
    Root --> D[资金结算与清分]
    Root --> E[数据服务]

    A --> A1[商户入网审核]
    A --> A2[账户开户]
    A --> A3[账户信息维护]

    B --> B1[协议签署]
    B --> B2[身份认证<br/>(打款/人脸)]
    B --> B3[绑定关系管理]

    C --> C1[分账指令处理]
    C --> C2[批量付款处理]
    C --> C3[手续费计算]
    C --> C4[交易状态管理]

    D --> D1[主动/被动结算]
    D --> D2[手续费清分]
    D --> D3[资金划转]

    E --> E1[交易数据提供]
    E --> E2[对账单生成]
```

## 2.3 网络拓扑图
TBD

## 2.4 数据流转
数据在系统各模块间按业务流程定向流转。核心数据流包括：商户/账户信息流、关系绑定流、分账交易流、资金流及对账数据流。天财通过三代发起业务请求，数据经行业钱包协调，在账户系统、认证系统等模块间处理，最终由对账单系统聚合输出。

```mermaid
flowchart TD
    T[天财] -->|1. 提交开户/绑定/分账请求| G[三代]
    G -->|2. 转发业务指令| HW[行业钱包]
    
    subgraph 账户与认证流程
        HW -->|3. 请求开户/升级| ACS[账户系统]
        HW -->|4. 发起签约| ES[电子签约平台]
        ES -->|5. 调用认证| AS[认证系统]
        AS -->|6. 返回认证结果| ES
        ES -->|7. 通知签约完成| HW
    end

    subgraph 交易处理流程
        HW -->|8. 发起分账/转账| TS[交易系统]
        TS -->|9. 请求计费| FS[计费中台]
        TS -->|10. 执行资金划转| ACS
        FS -->|11. 发布清分事件| CL[清结算]
        TS -->|12. 通知交易结果| HW
    end

    subgraph 数据同步流程
        HW -->|13. 同步交易数据| BC[业务核心]
        P[交易系统-收单] -->|14. 推送原始交易| BC
        BC -->|15. 提供结构化数据| SS[对账单系统]
        ACS -->|16. 提供账户动账数据| SS
        SS -->|17. 生成对账单| T
    end
```

## 2.5 系统模块交互关系
模块间主要通过同步API调用和异步事件进行交互。三代是主要的外部请求入口和协调者。行业钱包是核心的业务处理器，与最多数量的下游系统交互。账户系统、电子签约平台、认证系统等提供原子化的专业服务。

```mermaid
graph LR
    G[三代]
    HW[行业钱包]
    ACS[账户系统]
    ES[电子签约平台]
    AS[认证系统]
    FS[计费中台]
    CL[清结算]
    SS[对账单系统]
    BC[业务核心]
    TS[交易系统]
    BS[代付系统]
    AC[账务核心]
    P[交易系统-收单]
    W[钱包APP/商服平台]
    T[天财]

    T -- 业务请求 --> G
    W -- 用户操作 --> G
    
    G -- 协调开户/绑定/分账 --> HW
    G -- 发起签约 --> ES
    G -- 配置计费规则 --> FS

    HW -- 账户操作 --> ACS
    HW -- 发起/查询签约 --> ES
    HW -- 调用认证 --> AS
    HW -- 请求计费 --> FS
    HW -- 触发结算/查询 --> CL
    HW -- 同步数据 --> BC
    HW -- 提供数据 --> SS

    ES -- 身份核验 --> AS
    AS -- 认证结果回调 --> ES

    FS -- 清分指令 --> CL
    ACS -- 资金结算 --> CL
    ACS -- 底层账务操作 --> AC

    BC -- 提供分账交易数据 --> SS
    P -- 提供原始交易数据 --> BC

    TS -- 处理分账交易 --> HW
    TS -- 资金扣划 --> ACS
    TS -- 手续费计算 --> FS
    TS -- 清分通知 --> CL

    BS -- 处理批量付款 --> HW
    BS -- 签约校验 --> ES
    BS -- 资金操作 --> ACS
    BS -- 计费 --> FS
    BS -- 清分 --> CL
```