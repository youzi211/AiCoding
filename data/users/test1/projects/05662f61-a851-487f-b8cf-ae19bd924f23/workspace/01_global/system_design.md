## 2.1 系统结构
本系统采用分层微服务架构，旨在为“天财”平台提供分账、账户管理、资金归集等核心金融服务。整体架构分为接入层、业务层、核心服务层和基础服务层，各层职责清晰，通过API进行松耦合交互。

- **接入层**：包括“天财”平台和“钱包APP/商服平台”，作为业务请求的发起端和用户交互界面。
- **业务层**：包括“三代”、“行业钱包”、“业务核心”、“交易系统”、“代付系统”，负责处理具体的业务流程、规则校验和状态管理。
- **核心服务层**：包括“清结算”、“计费中台”、“账户系统”、“账务核心”，提供资金处理、计费、账户操作等核心金融能力。
- **基础服务层**：包括“用户中心”、“认证系统”、“电子签章系统”、“对账单系统”、“风控”，提供用户标识、身份核验、协议签署、文件生成、风险控制等支撑能力。

```mermaid
flowchart TD
    subgraph A [接入层]
        TC[天财平台]
        APP[钱包APP/商服平台]
    end

    subgraph B [业务层]
        SD[三代]
        IW[行业钱包]
        BC[业务核心]
        TS[交易系统]
        PS[代付系统]
    end

    subgraph C [核心服务层]
        ST[清结算]
        FC[计费中台]
        AS[账户系统]
        AC[账务核心]
    end

    subgraph D [基础服务层]
        UC[用户中心]
        AT[认证系统]
        ES[电子签章系统]
        BS[对账单系统]
        RC[风控]
    end

    TC --> SD
    TC --> BC
    APP --> IW
    APP --> TS
    APP --> PS

    SD --> IW
    SD --> UC
    IW --> ST
    IW --> AT
    IW --> ES
    BC --> IW
    BC --> ST
    TS --> IW
    TS --> ST
    TS --> AS
    PS --> IW
    PS --> FC
    PS --> ES
    PS --> BS

    ST --> FC
    ST --> AS
    ST --> BS
    FC --> AC
    FC --> AS
    AS --> AC
    RC --> ST
```

## 2.2 功能结构
系统功能围绕账户管理、资金交易、协议认证、运营支撑四大核心领域展开。每个领域由相应的系统模块提供具体功能，共同支撑“天财”平台的业务运营。

- **账户管理域**：负责商户入驻、账户开立、用户标识生成及账户状态管理。
- **资金交易域**：处理各类资金流转业务，包括分账、归集、会员结算、批量付款及其相关的清分、结算、计费、记账操作。
- **协议认证域**：为资金交易提供前置的身份核验与法律授权保障，包括关系绑定、协议签署、打款验证、人脸验证。
- **运营支撑域**：提供风险控制、对账文件生成、业务配置等运营管理功能。

```mermaid
flowchart TD
    subgraph F1 [账户管理域]
        F1_A[商户入驻审核] --> SD
        F1_B[机构号分配] --> SD
        F1_C[账户开户] --> IW
        F1_D[用户ID生成] --> UC
    end

    subgraph F2 [资金交易域]
        F2_A[分账/归集/会员结算] --> TS
        F2_B[批量付款] --> PS
        F2_C[交易清分与结算] --> ST
        F2_D[手续费计算] --> FC
        F2_E[资金扣减/增加] --> AS
        F2_F[记账] --> AC
    end

    subgraph F3 [协议认证域]
        F3_A[关系绑定校验] --> IW
        F3_B[电子协议签署] --> ES
        F3_C[打款验证] --> AT
        F3_D[人脸验证] --> AT
    end

    subgraph F4 [运营支撑域]
        F4_A[风险冻结] --> RC
        F4_B[对账单生成] --> BS
        F4_C[业务规则配置] --> SD
    end

    TC --> F2_A
    APP --> F3_A
```

## 2.3 网络拓扑图
TBD

## 2.4 数据流转
以“分账”业务为例，描述一笔资金从请求发起至最终完成记账的数据流转过程。流程体现了请求的发起、业务校验、核心处理、资金操作及最终状态同步的完整链条。

1. 业务请求由“天财”平台发起，经“业务核心”接收并路由。
2. “交易系统”进行业务规则与账户状态校验，并调用“行业钱包”校验关系绑定。
3. “清结算”系统负责交易的清分与结算，调用“计费中台”计算手续费。
4. “计费中台”驱动“账务核心”与“账户系统”完成资金的扣减与增加。
5. 动账明细由“清结算”同步至“对账单系统”生成对账文件。
6. 各环节状态最终回传至“天财”平台。

```mermaid
flowchart LR
    A[天财: 发起分账] --> B[业务核心: 接收请求]
    B --> C[交易系统: 业务校验]
    C --> D[行业钱包: 关系绑定校验]
    D --> E[清结算: 清分与结算]
    E --> F[计费中台: 计算手续费与清分方案]
    F --> G[账务核心: 执行记账]
    G --> H[账户系统: 资金扣减/增加]
    H --> I[清结算: 同步动账明细]
    I --> J[对账单系统: 生成对账文件]
    J --> K[天财: 获取最终结果]
```

## 2.5 系统模块交互关系
模块间主要通过同步API调用进行交互，部分场景辅以异步事件通知。核心交互关系围绕业务流程展开，例如“三代”为“行业钱包”提供商户和机构信息以开户，“行业钱包”为“交易系统”提供关系绑定校验，“清结算”作为枢纽协调“计费中台”、“账户系统”和“对账单系统”完成资金处理。

- **强依赖调用**：如“交易系统”处理分账时，必须调用“行业钱包”校验关系绑定，调用“清结算”执行结算。
- **数据同步**：如“清结算”需从“账户系统”同步余额，并向“对账单系统”推送明细。
- **能力服务**：如“认证系统”、“电子签章系统”为上层业务提供可复用的认证与签署能力。

```mermaid
flowchart TD
    TC[天财] -->|1. 提交商户申请| SD[三代]
    TC -->|2. 发起分账请求| BC[业务核心]
    BC -->|3. 路由交易| TS[交易系统]
    TS -->|4. 校验关系| IW[行业钱包]
    SD -->|5. 调用开户| IW
    IW -->|6. 申请冻结/同步信息| ST[清结算]
    IW -->|7. 调起认证| AT[认证系统]
    IW -->|8. 调起签署| ES[电子签章系统]
    TS -->|9. 发起结算| ST
    ST -->|10. 计算费用| FC[计费中台]
    FC -->|11. 驱动记账| AC[账务核心]
    AC -->|12. 操作资金| AS[账户系统]
    ST -->|13. 同步余额| AS
    ST -->|14. 推送明细| BS[对账单系统]
    RC[风控] -->|15. 发起冻结| ST
    PS[代付系统] -->|16. 校验协议与关系| IW
    PS -->|17. 计算手续费| FC
    APP[钱包APP] -->|18. 查询账户/发起交易| IW
    APP -->|19. 获取签署链接| ES
```